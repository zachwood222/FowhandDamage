{% extends "base.html" %}
{% block content %}
<div class="card glass p-4">
  <form class="grid md:grid-cols-6 gap-3 items-end">
    <input class="border rounded-xl px-3 py-2" name="q" value="{{ request.args.get('q','') }}" placeholder="Search title/PO/SKU">
    <select class="border rounded-xl px-3 py-2" name="status">
      <option value="">All statuses</option>
      {% for s in statuses %}
        <option value="{{ s }}" {% if request.args.get('status')==s %}selected{% endif %}>{{ s }}</option>
      {% endfor %}
    </select>
    <input class="border rounded-xl px-3 py-2" name="vendor" value="{{ request.args.get('vendor','') }}" placeholder="Vendor">
    <input class="border rounded-xl px-3 py-2" name="date_from" type="date" value="{{ request.args.get('date_from','') }}">
    <select class="border rounded-xl px-3 py-2" name="sla">
      <option value="">SLA: All</option>
      <option value="overdue" {% if request.args.get('sla')=='overdue' %}selected{% endif %}>Overdue</option>
      <option value="due" {% if request.args.get('sla')=='due' %}selected{% endif %}>Due soon</option>
      <option value="ok" {% if request.args.get('sla')=='ok' %}selected{% endif %}>OK</option>
    </select>
    <button class="bg-slate-900 text-white rounded-xl px-3 py-2">Filter</button>
  </form>
</div>

<div class="mt-4 bg-white card p-4 overflow-x-auto">
  <div class="flex justify-between items-center mb-2">
    <h3 class="font-semibold">Items</h3>
    <a href="{{ url_for('new_item') }}" class="px-3 py-2 rounded-xl bg-emerald-600 text-white">New Item</a>
  </div>
  <form method="post" action="{{ url_for('bulk_apply_credit') }}">
    <div class="flex gap-2 items-center my-2">
      <select name="credit_id" class="border rounded-xl px-3 py-2">
        <option value="">Apply credit…</option>
        {% for c in open_credits %}
          <option value="{{ c.id }}">{{ c.vendor or 'Vendor' }} — {{ c.reference or 'ref' }} — ${{ '%.2f'|format(c.remaining_amount) }}</option>
        {% endfor %}
      </select>
      <input name="total_amount" placeholder="Total $" class="border rounded-xl px-3 py-2 w-36">
      <button class="px-3 py-2 rounded-xl bg-purple-600 text-white">Apply Evenly</button>
    </div>

    <table class="w-full text-sm">
      <thead class="text-left text-slate-600">
        <tr><th></th><th>ID</th><th>Title</th><th>Vendor</th><th>PO</th><th>SKU</th><th>Status</th><th>SLA</th><th>Created</th></tr>
      </thead>
      <tbody>
      {% for it in items %}
        <tr class="hover:bg-slate-50">
          <td><input type="checkbox" name="item_ids" value="{{ it.id }}"></td>
          <td><a class="text-indigo-700 underline" href="{{ url_for('item_detail', item_id=it.id) }}">#{{ it.id }}</a></td>
          <td>{{ it.title }}</td>
          <td>{{ it.vendor }}</td>
          <td>{{ it.po_number }}</td>
          <td>{{ it.sku }}</td>
          <td>
            <span class="badge {% if it.sla_status=='overdue' %}overdue{% elif it.sla_status=='due' %}due{% else %}ok{% endif %}">{{ it.status }}</span>
          </td>
          <td>{% if it.sla_status %}<span class="badge {{ it.sla_status }}">{{ it.sla_status }}{% if it.sla_days_left is not none %} ({{ it.sla_days_left }}){% endif %}</span>{% else %}-{% endif %}</td>
          <td>{{ it.created_at.strftime('%Y-%m-%d') if it.created_at }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </form>
</div>
{% endblock %}

{% extends "base.html" %}
{% block content %}
<div class="grid md:grid-cols-3 gap-4">
  <div class="md:col-span-2 bg-white card p-4">
    <div class="flex justify-between items-center">
      <h2 class="text-lg font-semibold">Item #{{ item.id }} — {{ item.title }}</h2>
      <div class="flex gap-2 items-center">
        <form method="post" action="{{ url_for('update_item_status', item_id=item.id) }}" class="flex gap-2 items-center">
          <select name="status" class="border rounded-xl px-3 py-1.5">
            {% for s in statuses %}<option value="{{ s }}" {% if item.status==s %}selected{% endif %}>{{ s }}</option>{% endfor %}
          </select>
          <button class="px-3 py-1.5 rounded-xl bg-slate-900 text-white">Save</button>
        </form>
        {% if role == 'admin' %}
        <form method="post" action="{{ url_for('delete_item', item_id=item.id) }}" onsubmit="return confirm('Delete this item?');">
          <button class="px-3 py-1.5 rounded-xl bg-rose-600 text-white">Delete</button>
        </form>
        {% endif %}
      </div>
    </div>
    <div class="text-sm text-slate-600 mt-1">Vendor: <b>{{ item.vendor or '-' }}</b> • PO: <b>{{ item.po_number or '-' }}</b> • SKU: <b>{{ item.sku or '-' }}</b></div>
    <div class="mt-2">
      {% if item.sla_status %}
        <span class="badge {{ item.sla_status }}">SLA: {{ item.sla_status }}{% if item.sla_days_left is not none %} ({{ item.sla_days_left }}){% endif %}</span>
      {% endif %}
    </div>

    <div class="mt-4">
      <h3 class="font-semibold mb-2">Attachments</h3>
      {% if item.attachments %}
        <ul class="list-disc pl-6">
          {% for a in item.attachments %}
            <li><a class="text-indigo-700 underline" href="{{ a.webview_link or a.drive_file_url }}" target="_blank">{{ a.name or a.filename or a.webview_link }}</a></li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="text-sm text-slate-500">No attachments yet.</div>
      {% endif %}
      <form method="post" action="{{ url_for('add_attachment', item_id=item.id) }}" class="mt-2 flex gap-2">
        <input name="url" placeholder="Paste link (Drive, photo, etc.)" class="border rounded-xl px-3 py-2 flex-1">
        <button class="px-3 py-2 rounded-xl bg-emerald-600 text-white">Add</button>
      </form>
      <form method="post" action="{{ url_for('upload_file', item_id=item.id) }}" enctype="multipart/form-data" class="mt-2 flex gap-2 items-center">
        <input type="file" name="file" accept="image/*,.pdf" class="border rounded-xl px-3 py-2" required />
        <button class="px-3 py-2 rounded-xl bg-emerald-600 text-white">Upload</button>
      </form>

      <div class="mt-6">
        <h3 class="font-semibold">Upload Photo/PDF to Drive (via Zap)</h3>
        <form method="post" action="{{ url_for('upload_to_drive', item_id=item.id) }}" enctype="multipart/form-data" class="flex gap-2 items-center">
          <input type="file" name="file" accept="image/*,.pdf" class="border rounded-xl px-3 py-2" required />
          <button class="px-3 py-2 rounded-xl bg-purple-600 text-white">Upload to Drive via Zap</button>
        </form>
        <p class="text-xs text-slate-500 mt-1">Sends the file to your Zap (OUTGOING_WEBHOOK_URL). The Zap uploads to Drive and calls back to <code>/zap/attach</code> to attach.</p>
      </div>

      <div class="mt-6">
        <h3 class="font-semibold mb-2">Notes</h3>
        {% if item.notes %}
          <ul class="list-disc pl-6 text-sm">
            {% for n in item.notes %}
              <li>{{ n.content }} <span class="text-slate-500">({{ n.created_at.strftime('%Y-%m-%d %H:%M') }})</span></li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-sm text-slate-500">No notes yet.</div>
        {% endif %}
        <form method="post" action="{{ url_for('add_note', item_id=item.id) }}" class="mt-2 flex gap-2">
          <input name="content" placeholder="Add note" class="border rounded-xl px-3 py-2 flex-1">
          <button class="px-3 py-2 rounded-xl bg-slate-900 text-white">Add</button>
        </form>
      </div>

      <div class="mt-3 flex gap-2">
        <form method="post" action="{{ url_for('send_claim', item_id=item.id) }}">
          <input type="hidden" name="to" value="{{ (item_vendor.email if item_vendor else '') }}">
          <button class="px-3 py-2 rounded-xl bg-indigo-600 text-white">Email Claim Packet</button>
        </form>
      </div>
    </div>
  </div>

  <div class="bg-white card p-4">
    <h3 class="font-semibold mb-2">Contact Vendor</h3>
    <form method="post" action="{{ url_for('contact_vendor_webhook', item_id=item.id) }}" class="grid gap-2">
      <input name="to" value="{{ (item_vendor.email if item_vendor else '') }}" placeholder="To" class="border rounded-xl px-3 py-2">
      <input name="subject" value="Damage claim for PO {{ item.po_number or '-' }} / SKU {{ item.sku or '-' }}" class="border rounded-xl px-3 py-2">
      <textarea name="body" class="border rounded-xl px-3 py-2" rows="6">Hello {{ item.vendor or '' }},

Please see attached photos and details for our damage claim on PO {{ item.po_number or '-' }} / SKU {{ item.sku or '-' }}.

Thank you,
Fowhand Furniture Claims</textarea>
      <button class="px-3 py-2 rounded-xl bg-slate-900 text-white">Send via Zapier</button>
    </form>

    <h3 class="font-semibold mt-6 mb-2">Credits on this Item</h3>
    {% if applications %}
      <ul class="list-disc pl-6 text-sm">
        {% for ap in applications %}
          <li>${{ '%.2f'|format(ap.amount_applied) }} from {{ ap.credit.reference if ap.credit else 'Credit' }} on {{ ap.applied_date.strftime('%Y-%m-%d') }}</li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="text-sm text-slate-500">No credits applied yet.</div>
    {% endif %}
  </div>
</div>
{% endblock %}
